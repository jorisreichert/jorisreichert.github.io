<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>RU/BigData-Blog6</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Page Wrapper -->
			<div id="page-wrapper">

				<!-- Header -->
					<header id="header">
						<h1><a href="index.html">Joris Reichert</a></h1>
						<nav>
							<a href="#menu">Menu</a>
						</nav>
					</header>

				<!-- Menu -->
					<nav id="menu">
						<div class="inner">
							<h2>Menu</h2>
							<ul class="links">
								<li><a href="index.html">Home</a></li>
								<li><a href="generic.html">Generic</a></li>
								<li><a href="elements.html">Elements</a></li>
								<li><a href="#">Log In</a></li>
								<li><a href="#">Sign Up</a></li>
							</ul>
							<a href="#" class="close">Close</a>
						</div>
					</nav>

				<!-- Wrapper -->
					<section id="wrapper">
						<header>
							<div class="inner">
								<h2>Final Project</h2>
								<p>Blog #6 for the Big Data course.</p>
							</div>
						</header>

						<!-- Content -->
							<div class="wrapper">
								<div class="inner">
									<h2 class="major">Introduction
									</h2>
									<p>
									Welcome to my sixth and final blogpost in the Big Data series. This blog is not like any of the others: for this final assignment I am to do a project to get hands-on experience in running and debugging jobs and working on large amounts of unstructured data. Now that may not sound very different from my previous blogposts, but the nuance lies in the word <i>large</i>. Large no longer means <i>the entire works of Shakespeare</i>, but now it refers to <b>the entire Commoncrawl webcrawl</b>!
                  The project also differs from the way of work so far, as I am to
                  <ol>
                    <li>Run Spark code standalone, outside the notebook interface;</li>
                    <li>Scale up our workload in multiple steps, to tackle the issues that I encounter one by one.</li>
                  </ol>
                  Luckily, we're still provided with instructions (in three parts) to help us get started on the project.
                  </p>

                  <h2 class="major">Instructions part 1: WARC files in Spark</h2>
                  <h3>Preliminaries</h3>
                  <p>
                  Sadly, it is time to retire our old and trusty docker image that we have been using in blogs 3 through 5. We're provided with something new, obtained and started by running:<pre><code>sudo docker pull rubigdata/course:project
sudo docker create --name cc -it -p 8080:8080 -p 9001:9001 -p 4040:4040 rubigdata/course:project
sudo docker start cc</code></pre>
                  Recall, on my system docker always requires sudo. Depending on your configuration you might not. Anyway, just like with our previous image we are now provdided with Zeppelin accessible from <code>http://localhost:9001/</code>.
                  </p>
                  <h3>Managing WARC files</h3>
                  <p>
                  To analyse how we can obtain data from WARC files we will look at the following piece of example code:</p>
                  <pre><code>// What are the text content-type records that were recorded in the crawl?
val wh = warcs.
        map{ wr => wr._2.getRecord() }.
        filter{ _.isHttp() }.
        map{ wr => (wr.getHeader().getUrl(),wr.getHttpHeaders().get("Content-Type")) }.
        filter{ 
            case(k,v) => v match { 
                case null => false
                case _ => v.startsWith("text") }
        }
wh.take(20).foreach{ println }</code></pre>
                  <p>
                  The first mapper is required to obtain the records of all warcs. Those records can still include records that contain images. We don't like images as they are harder to analyse, so we can use the filter function to check if the record is a HTTP (text) record.
                  </p><p>
                  The second mapper creates a tuple. The left half of the tuple opens the <b>WARC header</b> and obtains the URL from it. The right half of the header opens the <b>HTTP header</b> to obtain the content type from it.
                  </p><p>
                  The second filter filters out any tuples we created of which the content type (right side) does not start with the text "text". It seems like the only content-types are <code>text/html; charset=utf-8</code>, <code>text/css; charset=utf-8</code> and <code>null</code>. The last of those is filtered out, presumably those are HTTP requests as their content type is <i>null</i> and leaves us with only the HTTP responses. 
                  </p>
                  <h3>Parsing HTML</h3>
                  <p>
                  Once we have the HTML body (obtained by mapping <code>.getHttpStringBody()</code> on our warc records) we can use <code>Jsoup</code> to parse the HTML. Note that using "clean Jsoup code" with <code>def</code> can give Spark problems, which is most easy to work around by "inlining" more of your processing. Usefull references are <a href="https://jsoup.org/">the Jsoup website</a> and <a href="https://www.lihaoyi.com/post/ScrapingWebsitesusingScalaandJsoup.html">this blogpost</a>, the latter of which has some examples of using Jsoup in plain scala.
                  </p>
                  <p>
                  Here is some example code which creates and prints an RDD with tuples of the <i>title</i> of a page and each link on that page (the <code>href</code> destination of each <code>a</code> element in the page).
                  <pre><code>import org.jsoup.Jsoup
import org.jsoup.nodes.{Document,Element}
import collection.JavaConverters._

val wb = warcs.map{ wr => wr._2.getRecord().getHttpStringBody()}.
               map{ wb => {
                        val d = Jsoup.parse(wb)
                        val t = d.title()
                        val links = d.select("a").asScala
                        links.map(l => (t,l.attr("href"))).toIterator
                    }
                }.
                flatMap(identity)

// Inspect data:
wb.take(50).foreach(println)</code></pre>
                  </p>
                  <p>
                  We could slightly alter the <code>links.map(...)</code> line to also add the anchor text to the tuple.
<pre><code>links.map(l => (t,l.attr("href"),l.text())).toIterator</code></pre>
                  Anchor texts can be usefull. If I recall correctly, Wikipedia uses anchor texts of links that refer to their pages as a way of "determining/describing what the page is about". For example, in our data fragment two of our results are:
                  <pre>(Course Information,assignments/A1-preliminaries.html,A1)
(Course Information,assignments/A1-preliminaries.html,Blogging assignment)</pre>
                  Both "A1" and "Blogging assignment" are used to describe the hyperlink. As we know, the page is indeed a blogging assignment and we also have referred to it as "A1" (short for "Assignment 1").
                  </p>

                  <h2 class="major">Instructions part 2: Standalone Program</h2>
                  <p>
                  So far we have only used Spark inside Zeppelin Notebooks, in a very user-friendly interactive setting. As the concept of interactive notebooks does not work well with the concept of a cluster shared by many people, we want to convert our Zeppelin Notebook to a standalone application that we can run on the cluster. 
                  </p>

                  <h2><i>In Progress</i></h2>

  									<!-- <a href="#" class="image"><img src="images/Spark-SQL-stream-active-structured.png"/></a> -->
  										<!-- <a href="#" class="image"><img src="images/Spark-SQL-mace-vs-scimmy.png" style="max-width:100%"></a> -->
  									
      						<i>That's all, folks!</i>
      						I hope reading this blog taught you something new :)
      						<!-- <h4>To the peers giving feedback: I really appreciate extensive/in-depth feedback!! :D</h4> -->






									<!-- Referring to other articles -->
									<!-- <section class="features">
										<article>
											<a href="#" class="image"><img src="images/pic04.jpg" alt="" /></a>
											<h3 class="major">Sed feugiat lorem</h3>
											<p>Lorem ipsum dolor sit amet, consectetur adipiscing vehicula id nulla dignissim dapibus ultrices.</p>
											<a href="#" class="special">Learn more</a>
										</article>
										<article>
											<a href="#" class="image"><img src="images/pic05.jpg" alt="" /></a>
											<h3 class="major">Nisl placerat</h3>
											<p>Lorem ipsum dolor sit amet, consectetur adipiscing vehicula id nulla dignissim dapibus ultrices.</p>
											<a href="#" class="special">Learn more</a>
										</article>
									</section> -->

								</div>
							</div>

					</section>

				<!-- Footer -->
					<section id="footer">
						<div class="inner">
							<!-- <h2 class="major">Get in touch</h2>
							<p>Cras mattis ante fermentum, malesuada neque vitae, eleifend erat. Phasellus non pulvinar erat. Fusce tincidunt, nisl eget mattis egestas, purus ipsum consequat orci, sit amet lobortis lorem lacus in tellus. Sed ac elementum arcu. Quisque placerat auctor laoreet.</p>
							<form method="post" action="#">
								<div class="fields">
									<div class="field">
										<label for="name">Name</label>
										<input type="text" name="name" id="name" />
									</div>
									<div class="field">
										<label for="email">Email</label>
										<input type="email" name="email" id="email" />
									</div>
									<div class="field">
										<label for="message">Message</label>
										<textarea name="message" id="message" rows="4"></textarea>
									</div>
								</div>
								<ul class="actions">
									<li><input type="submit" value="Send Message" /></li>
								</ul>
							</form> -->
							<ul class="contact">
								<!-- <li class="icon solid fa-home">
									Untitled Inc<br />
									1234 Somewhere Road Suite #2894<br />
									Nashville, TN 00000-0000
								</li> -->
								<!-- <li class="icon solid fa-envelope"><a href="#">information@untitled.tld</a></li> -->
								<li class="icon brands fa-linkedin"><a href="#">linkedin.com/untitled-tld</a></li>
								<li class="icon brands fa-github"><a href="http://github.com/jorisreichert">github.com/jorisreichert</a></li>
							</ul>
							<ul class="copyright">
								<li>&copy; Joris Reichert. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</section>

			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>